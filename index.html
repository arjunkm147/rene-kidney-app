<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>REN√â - Kidney Health Hero</title>

  <!-- React + Babel + Tailwind CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind config (works with CDN) -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        container: { center: true, padding: { DEFAULT: '1rem', sm: '1.25rem', lg: '2rem' } },
        extend: {
          colors: {
            brand: {
              50: '#fff4f2', 100: '#fee6e2', 200: '#f8cdc7', 300: '#efaaa1', 400: '#e0877d',
              500: '#c86e64', 600: '#a75954', 700: '#8d4946', 800: '#6f3b39', 900: '#5a3230'
            },
            accent: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c' },
            good: '#10b981'
          },
          fontFamily: {
            sans: [
              'Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial',
              'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'
            ]
          },
          borderRadius: { xl: '1rem', '2xl': '1.25rem' },
          boxShadow: {
            soft: '0 2px 10px rgba(15,23,42,0.06)',
            card: '0 6px 24px rgba(15,23,42,0.08)'
          }
        }
      }
    }
  </script>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#a75954" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="REN√â" />
  <link rel="apple-touch-icon" href="rene-logo-new.png" />
  <link rel="manifest" href="manifest.json" />

  <!-- Fonts & base styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root { --bg-grad-start:#f8fafc; --bg-grad-end:#e2e8f0; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
      margin: 0; line-height: 1.55; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .rene-gradient { background: linear-gradient(135deg, #8b5a5a 0%, #a0706e 25%, #b8857f 50%, #d4a574 100%); }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:1rem; box-shadow:0 6px 24px rgba(15,23,42,.06); }
    .card-hover { transition:box-shadow .2s, transform .2s, border-color .2s; }
    .card-hover:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(15,23,42,.10); border-color:#cbd5e1; }
    .progress-track{height:6px;background:#e2e8f0;border-radius:999px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#10b981 0%,#059669 100%);border-radius:999px;transition:width .4s cubic-bezier(.16,1,.3,1)}
    .floating-header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);border-bottom:1px solid rgba(226,232,240,.9)}
    .bottom-nav{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-top:1px solid #e2e8f0;box-shadow:0 -6px 24px rgba(15,23,42,.06)}
    .app-shell{max-width:100%}
    @media (min-width:640px){.app-shell{max-width:480px}}
    @media (min-width:768px){.app-shell{max-width:800px}}
    @media (min-width:1024px){.app-shell{max-width:1000px}}
    .notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000;max-width:520px}
    .input{border:1px solid #e2e8f0;border-radius:0.75rem;padding:0.5rem 0.75rem}
    .pill{border:1px solid #e2e8f0;border-radius:999px;padding:0.25rem 0.6rem;font-size:.75rem}
  </style>
</head>
<body>
  <div id="root">
    <div class="min-h-screen grid place-items-center text-brand-600">
      <div class="text-center animate-pulse">
        <img src="rene-logo-new.png" alt="REN√â Logo" class="w-20 h-20 mx-auto mb-4 object-contain" />
        <div class="text-3xl font-extrabold">REN√â</div>
        <div class="text-base text-brand-500 mt-1">Kidney Coach</div>
        <div class="text-xs text-slate-500 mt-3">Loading your health journey...</div>
      </div>
    </div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ---------- Small UI tokens ----------
    const Shell = ({ children }) => (
      <div className="app-shell container mx-auto min-h-screen bg-white md:rounded-2xl md:shadow-card md:border md:border-slate-200 relative">
        {children}
      </div>
    );
    const Section = ({ children, className = '' }) => (<div className={`px-5 sm:px-6 md:px-8 ${className}`}>{children}</div>);
    const Card = ({ children, className = '' }) => (<div className={`card card-hover ${className}`}>{children}</div>);
    const Stat = ({ label, value, sub, className = '', variant = 'default' }) => {
      const isGradient = variant === 'onGradient';
      return (
        <div className={`rounded-xl text-center p-4 ${isGradient ? 'bg-white/10 border border-white/20 text-white' : 'bg-slate-50 border border-slate-200 text-slate-900'} ${className}`}>
          <div className={`text-2xl font-bold mb-1 ${isGradient ? 'text-white' : 'text-slate-900'}`}>{value}</div>
          <div className={`text-xs font-medium ${isGradient ? 'text-white/90' : 'text-slate-600'}`}>{label}</div>
          {sub && <div className={`text-[11px] mt-1 ${isGradient ? 'text-white/80' : 'text-slate-500'}`}>{sub}</div>}
        </div>
      );
    };
    const ReneBrand = ({ size = 'md' }) => {
      const sizes = { sm: ['w-8 h-8', 'text-lg'], md: ['w-12 h-12', 'text-2xl'], lg: ['w-16 h-16', 'text-3xl'] };
      const [img, txt] = sizes[size] || sizes.md;
      return (
        <div className="inline-flex items-center gap-3 select-none">
          <img src="rene-logo-new.png" alt="REN√â" className={`${img} object-contain drop-shadow`} />
          <span className={`font-extrabold text-white ${txt}`}>REN√â</span>
        </div>
      );
    };
    const Notification = ({ notice }) => notice && (
      <div className={`notification px-5 py-3 rounded-xl shadow-card text-white ${notice.type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'}`}>
        <div className="flex items-center gap-2 text-sm font-semibold">
          <span>{notice.type === 'success' ? '‚úÖ' : '‚ö†Ô∏è'}</span>
          <span>{notice.message}</span>
        </div>
      </div>
    );

    // ---------- Helpers: notifications & scheduling ----------
    const hasNotificationSupport = () => 'Notification' in window;
    const hasServiceWorkerSupport = () => 'serviceWorker' in navigator;
    const getPermission = () => (hasNotificationSupport() ? Notification.permission : 'denied');

    // next occurrence of "HH:MM" (24h), optionally constrained to allowed weekdays
    function nextDateTimeAt(timeStr, daysMask /* optional Set of weekday numbers 0-6 */, offsetMinutes = 0) {
      const [hh, mm] = timeStr.split(':').map(n => parseInt(n, 10));
      const now = new Date();
      let d = new Date();
      d.setSeconds(0,0);
      d.setHours(hh, mm, 0, 0);
      if (offsetMinutes) d = new Date(d.getTime() - offsetMinutes*60000);
      if (daysMask && daysMask.size) {
        while (d <= now || !daysMask.has(d.getDay())) {
          d.setDate(d.getDate() + 1);
          d.setHours(hh, mm, 0, 0);
          if (offsetMinutes) d = new Date(d.getTime() - offsetMinutes*60000);
        }
      } else {
        if (d <= now) {
          d.setDate(d.getDate() + 1);
          d.setHours(hh, mm, 0, 0);
          if (offsetMinutes) d = new Date(d.getTime() - offsetMinutes*60000);
        }
      }
      return d;
    }

    async function showBrowserNotification({ title, body, tag, data, icon = 'rene-logo-new.png', badge = 'rene-logo-new.png' }) {
      if (!hasNotificationSupport()) return false;
      try {
        if (hasServiceWorkerSupport()) {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) {
            await reg.showNotification(title, { body, tag, data, icon, badge, renotify:true });
            return true;
          }
        }
        if (Notification.permission === 'granted') {
          new Notification(title, { body, tag, data, icon, badge });
          return true;
        }
      } catch (e) { console.warn('Notification error:', e); }
      return false;
    }

    // ---------- MAIN APP ----------
    const App = () => {
      const [currentPage, setCurrentPage] = useState('home');
      const [notice, setNotice] = useState(null);

      // External Mobile Coach app link
      const MOBILE_COACH_URL = 'https://app.mobile-coach.eu/dl/store?dm03-wSqDVy1PRjhhP7j1YT9t0VmDt5fDe3SV';

      // Persist helpers
      const load = (k, fallback) => { try { return JSON.parse(localStorage.getItem(k)) ?? fallback; } catch { return fallback; } };
      const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

      // Reminders (richer)
      const defaultReminders = {
        enabled: true,
        settings: { snoozeMins: 10, preAlertMins: 10, sound: true, vibration: true,
          quiet: { enabled:false, start:'22:00', end:'07:00' } },
        meds: [
          { id: 'med1', name: 'Morning meds', time: '08:30', enabled: true },
          { id: 'med2', name: 'Evening meds', time: '20:00', enabled: true },
        ],
        dialysis: { enabled: true, time: '08:00', days: [1,3,5] }, // Mon/Wed/Fri
        hydration: { enabled: true, intervalMins: 120, activeStart: '09:00', activeEnd: '19:00' }
      };
      const [reminders, setReminders] = useState(() => load('rene.reminders', defaultReminders));
      const timersRef = useRef({ daily: [], dialysis: null, hydration: null, preview: [] }); // preview timers for demo only

      // Missions
      const defaultMissions = [
        { id: 1, title: 'Morning Medication', xp: 50, cat: 'Medication', done: true, daily: true },
        { id: 2, title: 'Hydration Target (‚â§ 2L)', xp: 30, cat: 'Hydration', done: false, daily: true },
        { id: 3, title: 'Walk 8000 steps', xp: 40, cat: 'Activity', done: false, daily: true },
        { id: 4, title: 'Evening Medication', xp: 50, cat: 'Medication', done: false, daily: true },
        { id: 5, title: 'Mood Check-in', xp: 20, cat: 'Wellness', done: false, daily: true },
      ];
      const [missions, setMissions] = useState(() => load('rene.missions', defaultMissions));
      const [missionFilter, setMissionFilter] = useState('All');

      // Chat
      const [chatMessages, setChatMessages] = useState([
        { id: 1, user: 'Sofia', message: 'Completed 7-day streak üéâ', time: '5m', likes: 12, avatar: 'ü¶∏‚Äç‚ôÄÔ∏è' },
        { id: 2, user: 'Marcus', message: 'Intensity minutes up to 120 this week!', time: '18m', likes: 6, avatar: 'ü¶∏‚Äç‚ôÇÔ∏è' },
      ]);
      const [newMessage, setNewMessage] = useState('');

      // Meds database
      const defaultMedsList = [
        { id: 'rx1', name: 'Sevelamer', dose: '800 mg', notes: 'With meals', times: ['08:30','12:30','18:30'], refillDate: '' },
        { id: 'rx2', name: 'Erythropoietin', dose: '10,000 IU', notes: 'SC, weekly', times: ['18:00'], refillDate: '' },
      ];
      const [medsList, setMedsList] = useState(() => load('rene.meds', defaultMedsList));
      const [takenToday, setTakenToday] = useState(() => load('rene.meds.taken.'+new Date().toDateString(), {}));

      // Symptom logs
      const [symptomLogs, setSymptomLogs] = useState(() => load('rene.symptoms', []));

      // Dialysis logs
      const [dialysisLogs, setDialysisLogs] = useState(() => load('rene.dialysisLogs', []));

      // Hero data & streak (same as before)
      const [heroData, setHeroData] = useState({
        name: 'Leandro', age: 15, location: 'Lausanne', level: 8, xp: 1840, xpToNext: 2000, totalPoints: 15420, joinDate: 'March 2024'
      });
      const [streakData, setStreakData] = useState({
        currentStreak: 5, bestStreak: 7, medicationTaken: true, medicationTime: '08:30 AM',
        fluidIntake: 1400, fluidTarget: 2000, stepCount: 6200, stepTarget: 8000,
        intensityMinutes: 36, intensityTarget: 150, sleepHours: 7.5, moodRating: 4
      });

      // Dialysis session runtime
      const [dialysisActive, setDialysisActive] = useState(false);
      const [dialysisTimer, setDialysisTimer] = useState({ startedAt: null, elapsed: 0, durationMins: 240 });
      const dialysisTimerRef = useRef(null);

      // SW + notifications
      const [perm, setPerm] = useState(getPermission());
      const [swReady, setSwReady] = useState(false);

      const notify = (message, type = 'success', timeout = 2500) => {
        setNotice({ message, type });
        if (timeout) setTimeout(() => setNotice(null), timeout);
      };

      // ---------- Utilities ----------
      const saveMeds = (v) => { setMedsList(v); save('rene.meds', v); };
      const saveReminders = (v) => { setReminders(v); save('rene.reminders', v); };
      const saveMissions = (v) => { setMissions(v); save('rene.missions', v); };
      const saveSymptoms = (v) => { setSymptomLogs(v); save('rene.symptoms', v); };
      const saveDialysisLogs = (v) => { setDialysisLogs(v); save('rene.dialysisLogs', v); };

      // ---------- Router & hash deep-links ----------
      useEffect(() => {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('sw.js').then(() => navigator.serviceWorker.ready).then(() => setSwReady(true)).catch(()=>{});
          navigator.serviceWorker.addEventListener?.('message', (e) => {
            if (e.data?.type === 'NOTIF_CLICKED' && e.data.url) {
              const hash = new URL(e.data.url, location.href).hash;
              routeHash(hash);
            }
          });
        }
        // initial route from hash
        routeHash(location.hash);
        window.addEventListener('hashchange', () => routeHash(location.hash));
        return () => window.removeEventListener('hashchange', () => routeHash(location.hash));
      }, []);

      useEffect(() => { // push current page to hash
        const map = { home:'#home', goals:'#goals', reminders:'#reminders', chat:'#chat', profile:'#profile', wellness:'#wellness', symptoms:'#symptoms', meds:'#meds', dialysis:'#dialysis' };
        const h = map[currentPage] || '#home';
        if (location.hash !== h) history.replaceState(null, '', h);
      }, [currentPage]);

      function routeHash(hash) {
        switch ((hash||'').toLowerCase()) {
          case '#meds': setCurrentPage('meds'); break;
          case '#dialysis': setCurrentPage('dialysis'); break;
          case '#symptoms': setCurrentPage('symptoms'); break;
          case '#reminders': setCurrentPage('reminders'); break;
          case '#goals': setCurrentPage('goals'); break;
          case '#chat': setCurrentPage('chat'); break;
          case '#profile': setCurrentPage('profile'); break;
          case '#wellness': setCurrentPage('wellness'); break;
          default: setCurrentPage('home');
        }
      }

      const requestPermission = async () => {
        if (!hasNotificationSupport()) { notify('Notifications not supported on this browser', 'error'); return; }
        try {
          const result = await Notification.requestPermission();
          setPerm(result);
          notify(result === 'granted' ? 'Notifications enabled ‚úÖ' : 'Notifications blocked ‚ùå', result === 'granted' ? 'success' : 'error');
        } catch { notify('Permission request failed', 'error'); }
      };

      // ---------- Reminder scheduling ----------
      const clearAllTimers = () => {
        timersRef.current.daily.forEach(id => clearTimeout(id));
        timersRef.current.daily = [];
        if (timersRef.current.dialysis) clearTimeout(timersRef.current.dialysis);
        timersRef.current.dialysis = null;
        if (timersRef.current.hydration) clearInterval(timersRef.current.hydration);
        timersRef.current.hydration = null;
        timersRef.current.preview.forEach(id => clearTimeout(id));
        timersRef.current.preview = [];
      };

      function scheduleAll() {
        clearAllTimers();
        if (!reminders.enabled) return;

        const pre = reminders.settings?.preAlertMins || 0;

        // MEDS
        for (const m of reminders.meds) {
          if (!m.enabled) continue;
          const target = nextDateTimeAt(m.time, null, pre);
          const delay = Math.max(0, target - new Date());
          const id = setTimeout(function tick() {
            showBrowserNotification({
              title: `üíä ${m.name}`,
              body: pre ? `Starts in ${pre} min (${m.time})` : `It's ${m.time}. Mark dose taken.`,
              tag: `med-${m.id}-${m.time}`,
              data: { url: location.origin + location.pathname + '#meds' }
            }).then(ok => { if (!ok) notify(`üíä ${m.name} reminder`, 'success'); });
            const next = nextDateTimeAt(m.time, null, pre);
            const nextDelay = Math.max(0, next - new Date());
            const newId = setTimeout(tick, nextDelay);
            const idx = timersRef.current.daily.indexOf(id);
            if (idx !== -1) timersRef.current.daily[idx] = newId;
          }, delay);
          timersRef.current.daily.push(id);
        }

        // DIALYSIS
        if (reminders.dialysis?.enabled && reminders.dialysis.days?.length) {
          const days = new Set(reminders.dialysis.days);
          const t = nextDateTimeAt(reminders.dialysis.time, days, pre);
          const delay = Math.max(0, t - new Date());
          timersRef.current.dialysis = setTimeout(function rearm() {
            showBrowserNotification({
              title: 'ü©∫ Dialysis',
              body: pre ? `Session starts in ${pre} min (${reminders.dialysis.time})` : `Session at ${reminders.dialysis.time}`,
              tag: 'dialysis-reminder',
              data: { url: location.origin + location.pathname + '#dialysis' }
            }).then(ok => { if (!ok) notify('ü©∫ Dialysis reminder', 'success'); });
            const next = nextDateTimeAt(reminders.dialysis.time, days, pre);
            const nextDelay = Math.max(0, next - new Date());
            timersRef.current.dialysis = setTimeout(rearm, nextDelay);
          }, delay);
        }

        // HYDRATION
        if (reminders.hydration?.enabled) {
          const intervalMs = Math.max(15, reminders.hydration.intervalMins || 120) * 60 * 1000;
          timersRef.current.hydration = setInterval(() => {
            const now = new Date();
            const [sh, sm] = (reminders.hydration.activeStart || '09:00').split(':').map(Number);
            const [eh, em] = (reminders.hydration.activeEnd || '19:00').split(':').map(Number);
            const s = new Date(now); s.setHours(sh, sm, 0, 0);
            const e = new Date(now); e.setHours(eh, em, 0, 0);
            // quiet hours check
            if (reminders.settings?.quiet?.enabled) {
              const [qh, qm] = (reminders.settings.quiet.start || '22:00').split(':').map(Number);
              const [qh2, qm2] = (reminders.settings.quiet.end || '07:00').split(':').map(Number);
              const qs = new Date(now); qs.setHours(qh, qm, 0, 0);
              const qe = new Date(now); qe.setHours(qh2, qm2, 0, 0);
              // handle overnight window
              const inQuiet = qs <= qe ? (now >= qs && now <= qe) : (now >= qs || now <= qe);
              if (inQuiet) return; // skip hydration during quiet hours
            }
            if (now >= s && now <= e) {
              showBrowserNotification({ title: 'üíß Hydration target', body: 'Quick sip to stay on target.', tag: 'hydration', data: { url: location.href } })
                .then(ok => { if (!ok) notify('üíß Hydration nudge', 'success'); });
            }
          }, intervalMs);
        }
      }

      useEffect(() => { save('rene.reminders', reminders); scheduleAll(); }, [reminders]);

      // ---------- Missions ----------
      const completeMission = (id) => {
        setMissions(prev => {
          const next = prev.map(m => m.id === id ? { ...m, done: true } : m);
          saveMissions(next);
          const ms = prev.find(m => m.id === id);
          if (ms && !ms.done) {
            setHeroData(h => ({ ...h, xp: h.xp + (ms.xp || 0) }));
            notify(`+${ms.xp} XP ‚Ä¢ ${ms.title}`);
          }
          return next;
        });
      };
      const addMission = (newM) => {
        setMissions(prev => {
          const next = [{ ...newM, id: Date.now(), done:false }, ...prev];
          saveMissions(next);
          notify('Mission added');
          return next;
        });
      };
      const resetDailyMissions = () => {
        setMissions(prev => {
          const next = prev.map(m => m.daily ? { ...m, done:false } : m);
          saveMissions(next);
          notify('Daily missions reset');
          return next;
        });
      };

      // ---------- Med doses ----------
      const markDoseTaken = (medId, time) => {
        const key = 'rene.meds.taken.' + new Date().toDateString();
        const updated = { ...takenToday, [medId + '|' + time]: true };
        setTakenToday(updated);
        save(key, updated);
        notify('Dose marked as taken');
      };

      // ---------- Dialysis runtime ----------
      const startDialysis = () => {
        if (dialysisActive) return;
        setDialysisActive(true);
        const startedAt = Date.now();
        setDialysisTimer({ startedAt, elapsed: 0, durationMins: dialysisTimer.durationMins });
        dialysisTimerRef.current = setInterval(() => {
          setDialysisTimer(t => ({ ...t, elapsed: Math.floor((Date.now() - startedAt)/1000) }));
        }, 1000);
        notify('Dialysis session started. You will get periodic check-ins.', 'success', 3000);
      };
      const endDialysis = () => {
        if (dialysisTimerRef.current) clearInterval(dialysisTimerRef.current);
        dialysisTimerRef.current = null;
        setDialysisActive(false);
        setDialysisTimer({ startedAt:null, elapsed:0, durationMins: dialysisTimer.durationMins });
        const log = { id: Date.now(), date: new Date().toISOString(), durationMins: dialysisTimer.durationMins, notes: '' };
        const next = [log, ...dialysisLogs];
        saveDialysisLogs(next);
        notify('Session ended & logged', 'success');
      };
      useEffect(() => () => { if (dialysisTimerRef.current) clearInterval(dialysisTimerRef.current); }, []);

      // ---------- Home ----------
      const Home = () => (
        <Shell>
          <Notification notice={notice} />
          <div className="rene-gradient floating-header">
            <Section className="py-6">
              <div className="flex items-center justify-between">
                <ReneBrand size="md" />
                <div className="text-right text-white/95">
                  <div className="text-xs opacity-90 font-medium">Welcome back</div>
                  <div className="font-bold text-lg">{heroData.name}</div>
                  <div className="text-[11px] opacity-85 mt-0.5">{heroData.age} ‚Ä¢ {heroData.location}</div>
                </div>
              </div>

              <Card className="mt-5 p-5">
                <div className="flex items-start justify-between">
                  <div>
                    <div className="text-2xl font-extrabold text-slate-800">Level {heroData.level}</div>
                    <div className="text-xs text-slate-600 font-medium">Kidney Health Hero</div>
                  </div>
                  <div className="text-right">
                    <div className="text-xl font-extrabold text-accent-600">{heroData.xp}</div>
                    <div className="text-[11px] text-slate-500 font-medium">XP Points</div>
                  </div>
                </div>
                <div className="progress-track mt-3">
                  <div className="progress-fill" style={{ width: `${(heroData.xp / heroData.xpToNext) * 100}%` }} />
                </div>
                <div className="text-[11px] text-slate-600 font-medium mt-1.5">
                  {heroData.xpToNext - heroData.xp} XP to Level {heroData.level + 1}
                </div>
              </Card>
            </Section>
          </div>

          <Section className="py-6 space-y-8 pb-28">
            <div className="rounded-2xl p-6 text-white shadow-card bg-gradient-to-tr from-orange-500 via-orange-400 to-amber-400">
              <div className="flex items-start justify-between">
                <div>
                  <h3 className="text-2xl font-extrabold mb-1">üî• {streakData.currentStreak} Day Streak</h3>
                  <p className="text-white/90 text-xs font-medium">Best: {streakData.bestStreak} days</p>
                </div>
                <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-white/90 text-orange-800">Active</span>
              </div>

              <div className="mt-5 grid grid-cols-7 gap-2">
                {[...Array(7)].map((_, i) => (
                  <div key={i} className={`${i < streakData.currentStreak ? 'bg-white' : 'bg-white/40'} h-3 rounded-full`} />
                ))}
              </div>

              <div className="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-4">
                <Stat variant="onGradient" label="Medicine" value={streakData.medicationTaken ? '‚úì' : '‚óã'} />
                <Stat variant="onGradient" label="Hydration Target" value={`${Math.round((streakData.fluidIntake / streakData.fluidTarget) * 100)}%`} sub={`${streakData.fluidIntake} / ${streakData.fluidTarget} ml`} />
                <Stat variant="onGradient" label="Steps" value={`${(streakData.stepCount/1000).toFixed(1)}k`} sub={`Target ${Math.round(streakData.stepTarget/1000)}k`} />
                <Stat variant="onGradient" label="Intensity min" value={`${streakData.intensityMinutes}m`} sub={`/ ${streakData.intensityTarget} weekly`} />
              </div>
            </div>

            {/* Quick Access modules */}
            <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <a href={MOBILE_COACH_URL} target="_blank" rel="noopener noreferrer" className="block focus:outline-none focus:ring-2 focus:ring-accent-500 rounded-xl">
                <Card className="p-5">
                  <div className="text-3xl mb-2">üì±</div>
                  <div className="font-bold text-slate-800">Chat with RENE Coach</div>
                  <div className="text-sm text-slate-600">Open chat app</div>
                  <div className="mt-2 text-accent-600 text-sm font-semibold">Open in new tab ‚Üí</div>
                </Card>
              </a>

              <Card className="p-5 cursor-pointer" onClick={() => setCurrentPage('reminders')}>
                <div className="text-3xl mb-2">‚è∞</div>
                <div className="font-bold text-slate-800">Reminders</div>
                <div className="text-sm text-slate-600">Dialysis ‚Ä¢ Meds ‚Ä¢ Hydration</div>
              </Card>

              <Card className="p-5 cursor-pointer" onClick={() => setCurrentPage('goals')}>
                <div className="text-3xl mb-2">‚öôÔ∏è</div>
                <div className="font-bold text-slate-800">Mission Center</div>
                <div className="text-sm text-slate-600">Track your daily goals</div>
              </Card>

              <Card className="p-5 cursor-pointer" onClick={() => setCurrentPage('chat')}>
                <div className="text-3xl mb-2">üë•</div>
                <div className="font-bold text-slate-800">Hero Alliance</div>
                <div className="text-sm text-slate-600">Challenges & leaderboard</div>
                <div className="flex items-center gap-2 mt-1"><span className="w-2 h-2 rounded-full bg-emerald-500"></span><span className="text-[11px] font-semibold text-emerald-600">4 online</span></div>
              </Card>

              <Card className="p-5 cursor-pointer" onClick={() => setCurrentPage('wellness')}>
                <div className="text-3xl mb-2">üßò</div>
                <div className="font-bold text-slate-800">Wellness</div>
                <div className="text-sm text-slate-600">Mindfulness & content</div>
              </Card>

              <Card className="p-5 cursor-pointer" onClick={() => setCurrentPage('dialysis')}>
                <div className="text-3xl mb-2">ü©∫</div>
                <div className="font-bold text-slate-800">Dialysis</div>
                <div className="text-sm text-slate-600">Session tools & check-ins</div>
              </Card>

              <Card className="p-5 cursor-pointer" onClick={() => setCurrentPage('symptoms')}>
                <div className="text-3xl mb-2">üìù</div>
                <div className="font-bold text-slate-800">Symptom Tracker</div>
                <div className="text-sm text-slate-600">Quick daily check-in</div>
              </Card>

              <Card className="p-5 cursor-pointer" onClick={() => setCurrentPage('meds')}>
                <div className="text-3xl mb-2">üíä</div>
                <div className="font-bold text-slate-800">Medication Overview</div>
                <div className="text-sm text-slate-600">Doses ‚Ä¢ Adherence ‚Ä¢ Refills</div>
              </Card>
            </div>
          </Section>

          {/* Bottom nav */}
          <div className="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-screen-lg bottom-nav">
            <div className="mx-auto max-w-[1000px]">
              <div className="grid grid-cols-4 gap-2 px-4 py-3">
                <button className="flex flex-col items-center rounded-lg py-1 text-accent-600 bg-accent-50 font-semibold"><div className="text-xl">üè†</div><span className="text-[11px]">Home</span></button>
                <button onClick={() => setCurrentPage('goals')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üéØ</div><span className="text-[11px] font-medium">Goals</span></button>
                <button onClick={() => setCurrentPage('chat')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üë•</div><span className="text-[11px] font-medium">Heroes</span></button>
                <button onClick={() => setCurrentPage('profile')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üë§</div><span className="text-[11px] font-medium">Profile</span></button>
              </div>
            </div>
          </div>
        </Shell>
      );

      // ---------- Mission Center ----------
      const Goals = () => {
        const cats = ['All','Medication','Hydration','Activity','Wellness','Custom'];
        const filtered = missions.filter(m => missionFilter==='All' ? true : m.cat===missionFilter);
        const weeklyComplete = missions.filter(m => m.done).length;
        const weeklyTotal = missions.length;

        // add mission form state
        const [form, setForm] = useState({ title:'', xp:20, cat:'Custom', daily:true });

        return (
          <Shell>
            <Notification notice={notice} />
            <div className="rene-gradient floating-header">
              <Section className="py-5 flex items-center gap-3 text-white">
                <button onClick={() => setCurrentPage('home')} className="text-2xl">‚Üê</button>
                <ReneBrand size="sm" />
                <span className="ml-auto text-lg font-bold">Mission Center</span>
              </Section>
            </div>

            <Section className="py-6 space-y-6 pb-28">
              <Card className="p-5">
                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                  <div>
                    <h3 className="text-lg font-bold text-slate-800">Weekly Overview</h3>
                    <p className="text-xs text-slate-600">{weeklyComplete}/{weeklyTotal} completed</p>
                  </div>
                  <div className="flex gap-2">
                    {cats.map(c => (
                      <button key={c} onClick={()=>setMissionFilter(c)} className={`pill ${missionFilter===c?'bg-accent-600 text-white border-accent-600':'bg-white text-slate-700'}`}>{c}</button>
                    ))}
                    <button onClick={resetDailyMissions} className="pill bg-white text-slate-700">Reset daily</button>
                  </div>
                </div>
              </Card>

              {/* Add custom mission */}
              <Card className="p-5">
                <div className="text-slate-800 font-bold mb-3">New Mission</div>
                <div className="grid sm:grid-cols-4 gap-3">
                  <input className="input" placeholder="e.g., 10-min stretch" value={form.title} onChange={e=>setForm({...form, title:e.target.value})}/>
                  <input type="number" className="input" placeholder="XP" min="5" max="200" value={form.xp} onChange={e=>setForm({...form, xp:parseInt(e.target.value||'0',10)})}/>
                  <select className="input" value={form.cat} onChange={e=>setForm({...form, cat:e.target.value})}>
                    <option>Medication</option><option>Hydration</option><option>Activity</option><option>Wellness</option><option>Custom</option>
                  </select>
                  <label className="inline-flex items-center gap-2"><input type="checkbox" checked={form.daily} onChange={e=>setForm({...form, daily:e.target.checked})}/><span className="text-sm">Repeat daily</span></label>
                </div>
                <div className="mt-3">
                  <button disabled={!form.title.trim()} onClick={()=>{ addMission(form); setForm({ title:'', xp:20, cat:'Custom', daily:true }); }} className="px-4 py-2 rounded-lg bg-accent-600 text-white font-semibold disabled:opacity-60">Add mission</button>
                </div>
              </Card>

              <div className="space-y-3">
                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><span>üéØ</span> Missions</h3>
                {filtered.map(m => (
                  <Card key={m.id} className="p-5">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <span className="text-3xl">{m.cat==='Medication'?'üíä':m.cat==='Hydration'?'üíß':m.cat==='Activity'?'üëü':m.cat==='Wellness'?'üßò':'‚≠ê'}</span>
                        <div>
                          <div className={`text-base font-bold ${m.done ? 'line-through text-slate-500' : 'text-slate-800'}`}>{m.title}</div>
                          <p className="text-xs text-slate-600 mt-0.5">{m.daily ? 'Daily' : 'One-off'} ‚Ä¢ {m.xp} XP ‚Ä¢ {m.cat}</p>
                        </div>
                      </div>
                      <button onClick={() => completeMission(m.id)} disabled={m.done} className={`px-5 py-2 rounded-lg font-bold text-sm ${m.done ? 'bg-emerald-600 text-white' : 'bg-accent-600 hover:bg-accent-500 text-white'}`}>{m.done ? '‚úì Done' : 'Complete'}</button>
                    </div>
                  </Card>
                ))}
              </div>
            </Section>

            <div className="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-screen-lg bottom-nav">
              <div className="mx-auto max-w-[1000px]">
                <div className="grid grid-cols-4 gap-2 px-4 py-3">
                  <button onClick={() => setCurrentPage('home')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üè†</div><span className="text-[11px] font-medium">Home</span></button>
                  <button className="flex flex-col items-center rounded-lg py-1 text-accent-600 bg-accent-50 font-semibold"><div className="text-xl">üéØ</div><span className="text-[11px]">Goals</span></button>
                  <button onClick={() => setCurrentPage('chat')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üë•</div><span className="text-[11px] font-medium">Heroes</span></button>
                  <button onClick={() => setCurrentPage('profile')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üë§</div><span className="text-[11px] font-medium">Profile</span></button>
                </div>
              </div>
            </div>
          </Shell>
        );
      };

      // ---------- Hero Alliance ----------
      const Chat = () => {
        const [tab, setTab] = useState('xp'); // xp | steps | intensity
        const [challengeForm, setChallengeForm] = useState({ type:'Hydration streak', opponent:'Sofia', lengthDays:3, prize:'50 XP' });

        const lbData = {
          xp:[{u:'Leandro',xp:420},{u:'Sofia',xp:380},{u:'Marcus',xp:310},{u:'Emma',xp:280}],
          steps:[{u:'Sofia',xp:9500},{u:'Leandro',xp:8200},{u:'Emma',xp:7000},{u:'Marcus',xp:6600}],
          intensity:[{u:'Marcus',xp:140},{u:'Leandro',xp:120},{u:'Emma',xp:95},{u:'Sofia',xp:90}],
        };
        const rows = lbData[tab];

        const sendMessage = () => {
          if (!newMessage.trim()) return;
          setChatMessages(ms => [{ id: ms.length + 1, user: heroData.name, message: newMessage, time: 'now', likes: 0, avatar: 'ü¶∏' }, ...ms]);
          setNewMessage('');
          notify('Message sent');
        };

        const inviteLink = () => {
          const link = location.origin + location.pathname + '#chat';
          navigator.clipboard?.writeText(link);
          notify('Invite link copied');
        };

        return (
          <Shell>
            <Notification notice={notice} />
            <div className="rene-gradient floating-header">
              <Section className="py-5 flex items-center gap-3 text-white">
                <button onClick={() => setCurrentPage('home')} className="text-2xl">‚Üê</button>
                <ReneBrand size="sm" />
                <span className="ml-auto text-lg font-bold">Hero Alliance</span>
              </Section>
            </div>

            <Section className="py-4 space-y-4 pb-28">
              <Card className="p-4">
                <div className="flex items-center justify-between">
                  <span className="text-sm font-bold text-slate-700 flex items-center gap-2"><span className="text-lg">üåü</span> Heroes Online</span>
                  <div className="flex items-center gap-2">
                    <span className="w-2 h-2 rounded-full bg-emerald-500"></span>
                    <span className="text-[11px] font-bold text-emerald-600">4 active</span>
                  </div>
                </div>
              </Card>

              {/* Challenges */}
              <Card className="p-4">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-slate-800 font-bold">Challenges</h3>
                  <button className="text-sm px-3 py-1 rounded-lg bg-slate-100" onClick={inviteLink}>Invite via link</button>
                </div>
                <div className="grid sm:grid-cols-2 gap-3">
                  <div className="border rounded-lg p-3">
                    <div className="font-semibold">Quick presets</div>
                    <div className="mt-2 grid grid-cols-2 gap-2">
                      {['Hydration 3d','Steps 10k/day','Intensity 100/wk','Meds streak 5d'].map((p,i)=>(
                        <button key={i} onClick={()=>notify(`Preset ‚Äú${p}‚Äù started`)} className="px-2 py-1 rounded bg-slate-100 text-sm">{p}</button>
                      ))}
                    </div>
                  </div>
                  <div className="border rounded-lg p-3">
                    <div className="font-semibold mb-2">Create a challenge</div>
                    <div className="grid grid-cols-2 gap-2">
                      <select className="input" value={challengeForm.type} onChange={e=>setChallengeForm({...challengeForm,type:e.target.value})}>
                        <option>Hydration streak</option><option>Steps per day</option><option>Intensity minutes</option><option>Medication adherence</option>
                      </select>
                      <select className="input" value={challengeForm.opponent} onChange={e=>setChallengeForm({...challengeForm,opponent:e.target.value})}>
                        <option>Sofia</option><option>Marcus</option><option>Emma</option><option>Open challenge</option>
                      </select>
                      <input className="input" type="number" min="1" max="30" value={challengeForm.lengthDays} onChange={e=>setChallengeForm({...challengeForm,lengthDays:parseInt(e.target.value||'1',10)})} placeholder="Days"/>
                      <input className="input" value={challengeForm.prize} onChange={e=>setChallengeForm({...challengeForm,prize:e.target.value})} placeholder="Prize"/>
                    </div>
                    <button className="mt-2 px-3 py-2 rounded bg-accent-600 text-white" onClick={()=>notify('Challenge created')}>Start</button>
                  </div>
                </div>
              </Card>

              {/* Leaderboards */}
              <Card className="p-4">
                <div className="flex gap-2 mb-3">
                  <button className={`pill ${tab==='xp'?'bg-accent-600 text-white border-accent-600':'bg-white'}`} onClick={()=>setTab('xp')}>Weekly XP</button>
                  <button className={`pill ${tab==='steps'?'bg-accent-600 text-white border-accent-600':'bg-white'}`} onClick={()=>setTab('steps')}>Steps</button>
                  <button className={`pill ${tab==='intensity'?'bg-accent-600 text-white border-accent-600':'bg-white'}`} onClick={()=>setTab('intensity')}>Intensity</button>
                </div>
                <div className="divide-y">
                  {rows.map((r,i)=> (
                    <div key={i} className="flex items-center justify-between py-2">
                      <div className="flex items-center gap-3">
                        <span className="w-6 text-center font-bold">{i+1}</span>
                        <span className="font-medium">{r.u}</span>
                      </div>
                      <span className="text-sm font-semibold text-slate-700">{r.xp}{tab==='xp'?' XP': tab==='steps'?' steps':' min'}</span>
                    </div>
                  ))}
                </div>
              </Card>

              {/* Chat feed */}
              <div className="space-y-3 min-h-[30vh]">
                {chatMessages.map(m => (
                  <Card key={m.id} className="p-4">
                    <div className="flex gap-4">
                      <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-rose-800 to-rose-600 text-white grid place-items-center text-xl">{m.avatar}</div>
                      <div className="flex-1">
                        <div className="flex items-center justify-between mb-1"><span className="font-bold text-slate-800">{m.user}</span><span className="text-[11px] text-slate-500 font-medium">{m.time}</span></div>
                        <p className="text-slate-700 mb-3 leading-relaxed">{m.message}</p>
                        <div className="flex items-center justify-between text-sm">
                          <button onClick={() => setChatMessages(prev => prev.map(x => x.id === m.id ? { ...x, likes: x.likes + 1 } : x))} className="inline-flex items-center gap-2 text-slate-500 hover:text-rose-600"><span>‚ù§Ô∏è</span><span className="font-medium">{m.likes}</span></button>
                          <button className="text-slate-500 hover:text-slate-700 font-medium">Reply</button>
                        </div>
                      </div>
                    </div>
                  </Card>
                ))}
              </div>
            </Section>

            {/* Fixed composer (mobile-friendly & non-overlapping) */}
            <div className="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-screen-lg px-4">
              <Card className="p-3">
                <form onSubmit={(e)=>{e.preventDefault(); sendMessage();}} className="flex gap-3">
                  <input type="text" value={newMessage} onChange={(e)=>setNewMessage(e.target.value)}
                    placeholder="Send encouragement to fellow heroes..." className="flex-1 px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-accent-500" />
                  <button type="submit" disabled={!newMessage.trim()} className="px-5 py-2 rounded-lg font-bold bg-accent-600 text-white disabled:opacity-60">Send</button>
                </form>
              </Card>
            </div>

            <div className="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-screen-lg bottom-nav">
              <div className="mx-auto max-w-[1000px]">
                <div className="grid grid-cols-4 gap-2 px-4 py-3">
                  <button onClick={() => setCurrentPage('home')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üè†</div><span className="text-[11px] font-medium">Home</span></button>
                  <button onClick={() => setCurrentPage('goals')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üéØ</div><span className="text-[11px] font-medium">Goals</span></button>
                  <button className="flex flex-col items-center rounded-lg py-1 text-accent-600 bg-accent-50 font-semibold"><div className="text-xl">üë•</div><span className="text-[11px]">Heroes</span></button>
                  <button onClick={() => setCurrentPage('profile')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üë§</div><span className="text-[11px] font-medium">Profile</span></button>
                </div>
              </div>
            </div>
          </Shell>
        );
      };

      // ---------- Reminders ----------
      const Reminders = () => {
        const [local, setLocal] = useState(reminders);
        const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        const permText = perm === 'default' ? 'Not requested' : (perm === 'granted' ? 'Granted' : 'Denied');

        const toggleDay = (i) => {
          const set = new Set(local.dialysis.days);
          if (set.has(i)) set.delete(i); else set.add(i);
          setLocal({...local, dialysis: {...local.dialysis, days: Array.from(set).sort()}});
        };

        const saveAll = () => { saveReminders(local); notify('Reminders saved & scheduled ‚úÖ'); };
        const sendTest = () => {
          showBrowserNotification({ title:'üîî Test', body:'If you see this, notifications are working!', tag:'test', data:{ url: location.href+'#reminders'} })
            .then(ok => { if (!ok) notify('Test shown in-app'); });
        };
        const demo = () => {
          ['üíä Medication','ü©∫ Dialysis','üíß Hydration'].forEach((t,i)=> setTimeout(()=>showBrowserNotification({ title:t, body:'Demo reminder', tag:'demo', data:{url:location.href}}), (i+1)*1000));
          notify('Demo queued‚Ä¶');
        };

        // Build a small preview of next triggers
        const nexts = [];
        const pre = local.settings?.preAlertMins || 0;
        for (const m of local.meds) {
          if (!m.enabled) continue;
          const d = nextDateTimeAt(m.time, null, pre);
          nexts.push({ label:`üíä ${m.name}`, time:d });
        }
        if (local.dialysis.enabled && local.dialysis.days.length) {
          const d = nextDateTimeAt(local.dialysis.time, new Set(local.dialysis.days), pre);
          nexts.push({ label:'ü©∫ Dialysis', time:d });
        }

        return (
          <Shell>
            <Notification notice={notice} />
            <div className="rene-gradient floating-header">
              <Section className="py-5 flex items-center gap-3 text-white">
                <button onClick={() => setCurrentPage('home')} className="text-2xl">‚Üê</button>
                <ReneBrand size="sm" />
                <span className="ml-auto text-lg font-bold">Reminders</span>
              </Section>
            </div>

            <Section className="py-6 space-y-6 pb-28">
              <Card className="p-5">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-bold">Notifications</div>
                    <div className="text-xs text-slate-500">Permission: <span className="font-semibold">{permText}</span> ‚Ä¢ SW: {swReady ? 'Ready' : '‚Äî'}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <button onClick={requestPermission} className="px-3 py-2 rounded-lg text-sm bg-slate-100">Enable</button>
                    <label className="inline-flex items-center gap-2 text-sm">
                      <input type="checkbox" checked={local.enabled} onChange={(e)=>setLocal({...local, enabled: e.target.checked})}/>
                      <span>Reminders on</span>
                    </label>
                  </div>
                </div>
                <div className="mt-3 flex gap-2">
                  <button onClick={sendTest} className="px-3 py-2 rounded-lg text-sm bg-accent-600 text-white">Send test</button>
                  <button onClick={demo} className="px-3 py-2 rounded-lg text-sm bg-slate-100">Demo triggers</button>
                </div>
              </Card>

              <Card className="p-5">
                <div className="font-bold mb-3">General settings</div>
                <div className="grid sm:grid-cols-3 gap-3">
                  <label className="text-sm">Pre-alert (mins)
                    <input type="number" className="input mt-1" min="0" max="60" value={local.settings.preAlertMins} onChange={e=>setLocal({...local, settings:{...local.settings, preAlertMins:parseInt(e.target.value||'0',10)}})} />
                  </label>
                  <label className="text-sm">Snooze (mins)
                    <input type="number" className="input mt-1" min="5" max="60" value={local.settings.snoozeMins} onChange={e=>setLocal({...local, settings:{...local.settings, snoozeMins:parseInt(e.target.value||'5',10)}})} />
                  </label>
                  <div className="flex items-center gap-4">
                    <label className="text-sm inline-flex items-center gap-2 mt-6"><input type="checkbox" checked={local.settings.sound} onChange={e=>setLocal({...local, settings:{...local.settings, sound:e.target.checked}})} /><span>Sound</span></label>
                    <label className="text-sm inline-flex items-center gap-2 mt-6"><input type="checkbox" checked={local.settings.vibration} onChange={e=>setLocal({...local, settings:{...local.settings, vibration:e.target.checked}})} /><span>Vibration</span></label>
                  </div>
                </div>
                <div className="mt-3 grid sm:grid-cols-3 gap-3">
                  <label className="text-sm">Quiet hours start
                    <input type="time" className="input mt-1" value={local.settings.quiet.start} onChange={e=>setLocal({...local, settings:{...local.settings, quiet:{...local.settings.quiet, start:e.target.value}}})}/>
                  </label>
                  <label className="text-sm">Quiet hours end
                    <input type="time" className="input mt-1" value={local.settings.quiet.end} onChange={e=>setLocal({...local, settings:{...local.settings, quiet:{...local.settings.quiet, end:e.target.value}}})}/>
                  </label>
                  <label className="text-sm inline-flex items-center gap-2 mt-6">
                    <input type="checkbox" checked={local.settings.quiet.enabled} onChange={e=>setLocal({...local, settings:{...local.settings, quiet:{...local.settings.quiet, enabled:e.target.checked}}})}/>
                    <span>Enable quiet hours</span>
                  </label>
                </div>
              </Card>

              <Card className="p-5">
                <div className="font-bold mb-3">Medication reminders</div>
                <div className="space-y-3">
                  {local.meds.map((m, idx) => (
                    <div key={m.id} className="grid grid-cols-12 items-center gap-3">
                      <input className="col-span-4 input" value={m.name} onChange={e=>{ const copy=[...local.meds]; copy[idx]={...m, name:e.target.value}; setLocal({...local, meds:copy}); }}/>
                      <input className="col-span-3 input" type="time" value={m.time} onChange={e=>{ const copy=[...local.meds]; copy[idx]={...m, time:e.target.value}; setLocal({...local, meds:copy}); }}/>
                      <label className="col-span-3 justify-self-end text-sm inline-flex items-center gap-2">
                        <input type="checkbox" checked={m.enabled} onChange={e=>{ const copy=[...local.meds]; copy[idx]={...m, enabled:e.target.checked}; setLocal({...local, meds:copy}); }}/>
                        <span>Enabled</span>
                      </label>
                      <button className="col-span-2 text-sm px-3 py-1 rounded bg-slate-100" onClick={()=>{ const mins = local.settings.snoozeMins || 10; setTimeout(()=>showBrowserNotification({title:`üíä ${m.name} (snoozed)`, body:`Reminder after ${mins} min`, tag:'snooze', data:{url:location.href+'#meds'}}), mins*60000); notify(`Snoozed ${mins} min`); }}>Snooze</button>
                    </div>
                  ))}
                </div>
                <button className="mt-3 px-3 py-2 rounded bg-slate-100 text-sm" onClick={()=>setLocal({...local, meds:[...local.meds, { id:'med'+Date.now(), name:'New medication', time:'09:00', enabled:true }]})}>Add medication reminder</button>
              </Card>

              <Card className="p-5">
                <div className="font-bold mb-3">Dialysis</div>
                <div className="grid sm:grid-cols-2 gap-3 items-center">
                  <label className="text-sm">Time
                    <input type="time" value={local.dialysis.time} className="mt-1 w-full input"
                           onChange={(e)=>setLocal({...local, dialysis: {...local.dialysis, time: e.target.value}})} />
                  </label>
                  <label className="text-sm inline-flex items-center gap-2 mt-6">
                    <input type="checkbox" checked={local.dialysis.enabled} onChange={(e)=>setLocal({...local, dialysis:{...local.dialysis, enabled: e.target.checked}})}/>
                    <span>Enabled</span>
                  </label>
                </div>
                <div className="mt-3 flex flex-wrap gap-2">
                  {weekdays.map((d,i)=> (
                    <button type="button" key={d} onClick={()=>toggleDay(i)}
                      className={`px-3 py-1 rounded-full text-sm border ${local.dialysis.days.includes(i) ? 'bg-accent-600 text-white border-accent-600' : 'bg-white text-slate-700 border-slate-200'}`}>
                      {d}
                    </button>
                  ))}
                </div>
              </Card>

              <Card className="p-5">
                <div className="font-bold mb-3">Hydration</div>
                <div className="grid sm:grid-cols-3 gap-3 items-center">
                  <label className="text-sm">Every (mins)
                    <input type="number" min="15" value={local.hydration.intervalMins} className="mt-1 w-full input"
                           onChange={(e)=>setLocal({...local, hydration: {...local.hydration, intervalMins: parseInt(e.target.value||'0',10)}})} />
                  </label>
                  <label className="text-sm">Active from
                    <input type="time" value={local.hydration.activeStart} className="mt-1 w-full input"
                           onChange={(e)=>setLocal({...local, hydration: {...local.hydration, activeStart: e.target.value}})} />
                  </label>
                  <label className="text-sm">to
                    <input type="time" value={local.hydration.activeEnd} className="mt-1 w-full input"
                           onChange={(e)=>setLocal({...local, hydration: {...local.hydration, activeEnd: e.target.value}})} />
                  </label>
                </div>
                <div className="mt-3">
                  <label className="text-sm inline-flex items-center gap-2">
                    <input type="checkbox" checked={local.hydration.enabled} onChange={(e)=>setLocal({...local, hydration: {...local.hydration, enabled: e.target.checked}})} />
                    <span>Enabled</span>
                  </label>
                </div>
              </Card>

              {/* Upcoming preview */}
              <Card className="p-5">
                <div className="font-bold mb-2">Upcoming</div>
                {nexts.length===0 ? <div className="text-sm text-slate-500">No events scheduled.</div> :
                  <ul className="text-sm space-y-1">
                    {nexts.sort((a,b)=>a.time-b.time).slice(0,5).map((n,i)=>(
                      <li key={i} className="flex items-center justify-between">
                        <span>{n.label}</span>
                        <span className="text-slate-600">{n.time.toLocaleString()}</span>
                      </li>
                    ))}
                  </ul>
                }
              </Card>

              <div className="flex gap-3">
                <button onClick={saveAll} className="px-4 py-2 rounded-lg bg-accent-600 text-white font-semibold">Save & Schedule</button>
                <button onClick={()=>saveReminders(defaultReminders)} className="px-4 py-2 rounded-lg bg-slate-100">Reset defaults</button>
              </div>
            </Section>
          </Shell>
        );
      };

      // ---------- Wellness ----------
      const Wellness = () => {
        const content = [
          { id:'w1', title:'Box Breathing (4-4-4-4)', mins:2, type:'Breathing' },
          { id:'w2', title:'Guided Body Scan', mins:5, type:'Mindfulness' },
          { id:'w3', title:'Sleep Story: Calm River', mins:10, type:'Sleep' },
          { id:'w4', title:'Gratitude Journal', mins:3, type:'Mindset' },
          { id:'w5', title:'Mini Stretch Routine', mins:4, type:'Movement' },
        ];
        const [done, setDone] = useState(() => new Set(load('rene.wellness.done', [])));
        const toggleDone = (id) => {
          const n = new Set(done);
          if (n.has(id)) n.delete(id); else n.add(id);
          setDone(n); save('rene.wellness.done', Array.from(n));
          notify(n.has(id)?'Session completed üéâ':'Marked incomplete');
        };

        return (
          <Shell>
            <Notification notice={notice} />
            <div className="rene-gradient floating-header">
              <Section className="py-5 flex items-center gap-3 text-white">
                <button onClick={() => setCurrentPage('home')} className="text-2xl">‚Üê</button>
                <ReneBrand size="sm" />
                <span className="ml-auto text-lg font-bold">Wellness</span>
              </Section>
            </div>
            <Section className="py-6 space-y-4 pb-28">
              <Card className="p-5">
                <div className="font-semibold mb-2">Today‚Äôs suggestions</div>
                <div className="grid sm:grid-cols-2 gap-3">
                  {content.map(c=>(
                    <div key={c.id} className="border rounded-xl p-3 flex items-center justify-between">
                      <div>
                        <div className="font-bold">{c.title}</div>
                        <div className="text-xs text-slate-500">{c.type} ‚Ä¢ {c.mins} min</div>
                      </div>
                      <button className={`px-3 py-1 rounded ${done.has(c.id)?'bg-emerald-600 text-white':'bg-slate-100'}`} onClick={()=>toggleDone(c.id)}>
                        {done.has(c.id)?'‚úì Done':'Start'}
                      </button>
                    </div>
                  ))}
                </div>
              </Card>
            </Section>
          </Shell>
        );
      };

      // ---------- Symptoms ----------
      const Symptoms = () => {
        const [entry, setEntry] = useState({ date: new Date().toISOString(), nausea:0, fatigue:0, cramps:0, itch:0, bp:'', notes:'' });

        const saveEntry = () => {
          const log = { ...entry, id: Date.now() };
          const next = [log, ...symptomLogs].slice(0, 50);
          saveSymptoms(next);
          notify('Symptoms saved');
        };

        return (
          <Shell>
            <Notification notice={notice} />
            <div className="rene-gradient floating-header">
              <Section className="py-5 flex items-center gap-3 text-white">
                <button onClick={() => setCurrentPage('home')} className="text-2xl">‚Üê</button>
                <ReneBrand size="sm" />
                <span className="ml-auto text-lg font-bold">Symptom Tracker</span>
              </Section>
            </div>
            <Section className="py-6 space-y-4 pb-28">
              <Card className="p-5 space-y-4">
                <div className="grid sm:grid-cols-2 gap-4">
                  {['nausea','fatigue','cramps','itch'].map(k=>(
                    <label key={k} className="block text-sm">
                      {k[0].toUpperCase()+k.slice(1)} (0‚Äì10)
                      <input type="range" min="0" max="10" value={entry[k]} onChange={e=>setEntry({...entry, [k]:parseInt(e.target.value,10)})} className="w-full"/>
                    </label>
                  ))}
                  <label className="block text-sm">
                    Blood pressure (mmHg)
                    <input className="input mt-1" placeholder="e.g., 120/80" value={entry.bp} onChange={e=>setEntry({...entry, bp:e.target.value})}/>
                  </label>
                </div>
                <label className="block text-sm">Notes<textarea className="input mt-1 w-full" rows="3" value={entry.notes} onChange={e=>setEntry({...entry, notes:e.target.value})}></textarea></label>
                <button className="px-4 py-2 rounded bg-accent-600 text-white" onClick={saveEntry}>Save</button>
              </Card>

              <Card className="p-5">
                <div className="font-bold mb-3">Recent entries</div>
                {symptomLogs.length===0 ? <div className="text-sm text-slate-500">No entries yet.</div> :
                  <div className="space-y-2">
                    {symptomLogs.slice(0,10).map(log=>(
                      <div key={log.id} className="border rounded-xl p-3 text-sm">
                        <div className="font-semibold">{new Date(log.date).toLocaleString()}</div>
                        <div className="text-slate-600">Nausea {log.nausea}/10 ‚Ä¢ Fatigue {log.fatigue}/10 ‚Ä¢ Cramps {log.cramps}/10 ‚Ä¢ Itch {log.itch}/10 ‚Ä¢ BP {log.bp||'‚Äî'}</div>
                        {log.notes && <div className="text-slate-600 mt-1">üìù {log.notes}</div>}
                      </div>
                    ))}
                  </div>
                }
              </Card>
            </Section>
          </Shell>
        );
      };

      // ---------- Medications ----------
      const Meds = () => {
        const [newMed, setNewMed] = useState({ name:'', dose:'', notes:'', times:['08:00'], refillDate:'' });

        const addMed = () => {
          const med = { ...newMed, id:'rx'+Date.now() };
          const next = [med, ...medsList];
          saveMeds(next);
          notify('Medication added');
          setNewMed({ name:'', dose:'', notes:'', times:['08:00'], refillDate:'' });
        };
        const removeMed = (id) => {
          const next = medsList.filter(m => m.id!==id);
          saveMeds(next);
        };

        const todayStr = new Date().toDateString();

        return (
          <Shell>
            <Notification notice={notice} />
            <div className="rene-gradient floating-header">
              <Section className="py-5 flex items-center gap-3 text-white">
                <button onClick={() => setCurrentPage('home')} className="text-2xl">‚Üê</button>
                <ReneBrand size="sm" />
                <span className="ml-auto text-lg font-bold">Medication Overview</span>
              </Section>
            </div>
            <Section className="py-6 space-y-6 pb-28">
              {/* Today doses */}
              <Card className="p-5">
                <div className="font-bold mb-3">Today‚Äôs doses</div>
                <div className="space-y-2">
                  {medsList.flatMap(m => m.times.map(t => ({ med:m, time:t }))).sort((a,b)=>a.time.localeCompare(b.time)).map(({med,time},i)=> {
                    const key = med.id + '|' + time;
                    const taken = takenToday[key];
                    return (
                      <div key={i} className="border rounded-xl p-3 flex items-center justify-between">
                        <div>
                          <div className="font-semibold">{med.name} ‚Äî {med.dose}</div>
                          <div className="text-xs text-slate-500">{time} ‚Ä¢ {med.notes || '‚Äî'}</div>
                        </div>
                        <button className={`px-3 py-1 rounded ${taken?'bg-emerald-600 text-white':'bg-slate-100'}`} disabled={taken} onClick={()=>markDoseTaken(med.id, time)}>{taken?'‚úì Taken':'Mark taken'}</button>
                      </div>
                    );
                  })}
                </div>
                <div className="text-[11px] text-slate-500 mt-2">Adherence saved as: ‚Äúrene.meds.taken.{todayStr}‚Äù</div>
              </Card>

              {/* Meds list */}
              <Card className="p-5">
                <div className="font-bold mb-3">Your medications</div>
                <div className="space-y-3">
                  {medsList.map(m=>(
                    <div key={m.id} className="border rounded-xl p-3">
                      <div className="flex items-start justify-between gap-2">
                        <div>
                          <div className="font-semibold">{m.name} ‚Äî {m.dose}</div>
                          <div className="text-xs text-slate-500">{m.notes || '‚Äî'}</div>
                          <div className="text-xs text-slate-600 mt-1">Times: {m.times.join(', ')}</div>
                          <div className="text-xs text-slate-600 mt-1">Refill by: {m.refillDate || '‚Äî'}</div>
                        </div>
                        <button className="px-2 py-1 rounded bg-rose-100 text-rose-700 text-sm" onClick={()=>removeMed(m.id)}>Remove</button>
                      </div>
                    </div>
                  ))}
                </div>
              </Card>

              {/* Add med */}
              <Card className="p-5">
                <div className="font-bold mb-2">Add a medication</div>
                <div className="grid sm:grid-cols-3 gap-3">
                  <input className="input" placeholder="Name" value={newMed.name} onChange={e=>setNewMed({...newMed, name:e.target.value})}/>
                  <input className="input" placeholder="Dose" value={newMed.dose} onChange={e=>setNewMed({...newMed, dose:e.target.value})}/>
                  <input className="input" placeholder="Notes (e.g., with meals)" value={newMed.notes} onChange={e=>setNewMed({...newMed, notes:e.target.value})}/>
                  <input className="input" placeholder="Times (HH:MM, comma-separated)" value={newMed.times.join(', ')} onChange={e=>setNewMed({...newMed, times:e.target.value.split(',').map(s=>s.trim()).filter(Boolean)})}/>
                  <input className="input" type="date" value={newMed.refillDate} onChange={e=>setNewMed({...newMed, refillDate:e.target.value})}/>
                </div>
                <div className="mt-3">
                  <button disabled={!newMed.name.trim()} className="px-4 py-2 rounded bg-accent-600 text-white disabled:opacity-60" onClick={addMed}>Add</button>
                </div>
              </Card>

              <Card className="p-5">
                <div className="text-sm text-slate-600">Tip: The <b>Reminders</b> page controls when notifications fire. Make sure medication times there match this overview for best results.</div>
              </Card>
            </Section>
          </Shell>
        );
      };

      // ---------- Dialysis ----------
      const Dialysis = () => {
        const [notes, setNotes] = useState('');
        const elapsedMins = Math.floor(dialysisTimer.elapsed / 60);
        const progress = Math.min(100, Math.floor((elapsedMins / dialysisTimer.durationMins) * 100)) || 0;

        const saveNote = () => {
          const log = { id: Date.now(), date: new Date().toISOString(), note: notes };
          const next = [log, ...dialysisLogs];
          saveDialysisLogs(next);
          setNotes('');
          notify('Note saved');
        };

        return (
          <Shell>
            <Notification notice={notice} />
            <div className="rene-gradient floating-header">
              <Section className="py-5 flex items-center gap-3 text-white">
                <button onClick={() => setCurrentPage('home')} className="text-2xl">‚Üê</button>
                <ReneBrand size="sm" />
                <span className="ml-auto text-lg font-bold">Dialysis</span>
              </Section>
            </div>
            <Section className="py-6 space-y-5 pb-28">
              <Card className="p-5">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-bold">Session tools</div>
                    <div className="text-xs text-slate-500">Timer, check-ins, notes & entertainment</div>
                  </div>
                  {!dialysisActive ? (
                    <button className="px-4 py-2 rounded bg-accent-600 text-white" onClick={startDialysis}>Start session</button>
                  ) : (
                    <button className="px-4 py-2 rounded bg-rose-600 text-white" onClick={endDialysis}>End session</button>
                  )}
                </div>
                <div className="mt-3">
                  <div className="text-xs text-slate-600">Duration target (mins)</div>
                  <input type="number" min="60" max="600" className="input mt-1 w-40" value={dialysisTimer.durationMins} onChange={e=>setDialysisTimer(t=>({...t, durationMins:parseInt(e.target.value||'240',10)}))}/>
                </div>
                {dialysisActive && (
                  <div className="mt-4">
                    <div className="text-sm font-semibold mb-1">Elapsed: {elapsedMins} min / {dialysisTimer.durationMins} min</div>
                    <div className="progress-track"><div className="progress-fill" style={{width:`${progress}%`}}/></div>
                  </div>
                )}
              </Card>

              <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <Card className="p-5 cursor-pointer" onClick={()=>setCurrentPage('symptoms')}>
                  <div className="text-2xl mb-2">üôÇ</div>
                  <div className="font-bold">Mood & Symptoms</div>
                  <div className="text-sm text-slate-600">Quick PROMs during session</div>
                </Card>
                <Card className="p-5 cursor-pointer" onClick={()=>notify('Opening mini games') }>
                  <div className="text-2xl mb-2">üéÆ</div>
                  <div className="font-bold">Mini-games</div>
                  <div className="text-sm text-slate-600">Light games to pass time</div>
                </Card>
                <Card className="p-5 cursor-pointer" onClick={()=>notify('Opening entertainment hub') }>
                  <div className="text-2xl mb-2">üéß</div>
                  <div className="font-bold">Entertainment</div>
                  <div className="text-sm text-slate-600">Music, podcasts, videos</div>
                </Card>
              </div>

              <Card className="p-5">
                <div className="font-semibold mb-2">Notes</div>
                <textarea className="input w-full" rows="3" value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Symptoms, events, anything notable‚Ä¶"></textarea>
                <button className="mt-2 px-3 py-2 rounded bg-slate-100" onClick={saveNote}>Save note</button>
              </Card>

              <Card className="p-5">
                <div className="font-bold mb-2">Recent session notes</div>
                {dialysisLogs.length===0 ? <div className="text-sm text-slate-500">No notes yet.</div> :
                  <ul className="text-sm space-y-2">
                    {dialysisLogs.slice(0,10).map(l=>(
                      <li key={l.id} className="border rounded-xl p-3">
                        <div className="font-semibold">{new Date(l.date).toLocaleString()}</div>
                        <div className="text-slate-600">{l.note||'‚Äî'}</div>
                      </li>
                    ))}
                  </ul>
                }
              </Card>
            </Section>
          </Shell>
        );
      };

      // ---------- Profile ----------
      const Profile = () => (
        <Shell>
          <Notification notice={notice} />
          <div className="rene-gradient floating-header">
            <Section className="py-5 flex items-center gap-3 text-white">
              <button onClick={() => setCurrentPage('home')} className="text-2xl">‚Üê</button>
              <ReneBrand size="sm" />
              <span className="ml-auto text-lg font-bold">Profile</span>
            </Section>
          </div>

          <Section className="py-6 space-y-6 pb-28">
            <div className="text-center">
              <div className="w-24 h-24 mx-auto rounded-2xl grid place-items-center bg-white/90 border border-white shadow-soft text-4xl">ü¶∏‚Äç‚ôÄÔ∏è</div>
              <h2 className="text-2xl font-extrabold text-slate-800 mt-3">{heroData.name}</h2>
              <p className="text-slate-600 text-sm">Level {heroData.level} Kidney Health Hero</p>
              <p className="text-slate-500 text-xs">{heroData.age} ‚Ä¢ {heroData.location} ‚Ä¢ since {heroData.joinDate}</p>
            </div>

            <Card className="p-5">
              <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><span>üìä</span> Your Stats</h3>
              <div className="grid sm:grid-cols-2 md:grid-cols-4 gap-4">
                <Stat label="Total XP" value={heroData.totalPoints} />
                <Stat label="Best Streak" value={streakData.bestStreak} />
                <Stat label="Medication Rate" value={'94%'} />
                <Stat label="Achievements" value={2} />
              </div>
            </Card>
          </Section>

          <div className="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-screen-lg bottom-nav">
            <div className="mx-auto max-w-[1000px]">
              <div className="grid grid-cols-4 gap-2 px-4 py-3">
                <button onClick={() => setCurrentPage('home')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üè†</div><span className="text-[11px] font-medium">Home</span></button>
                <button onClick={() => setCurrentPage('goals')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üéØ</div><span className="text-[11px] font-medium">Goals</span></button>
                <button onClick={() => setCurrentPage('chat')} className="flex flex-col items-center rounded-lg py-1 text-slate-600 hover:bg-slate-50"><div className="text-xl">üë•</div><span className="text-[11px] font-medium">Heroes</span></button>
                <button className="flex flex-col items-center rounded-lg py-1 text-accent-600 bg-accent-50 font-semibold"><div className="text-xl">üë§</div><span className="text-[11px]">Profile</span></button>
              </div>
            </div>
          </div>
        </Shell>
      );

      // ---------- Router ----------
      const Page = () => {
        switch (currentPage) {
          case 'home': return <Home/>;
          case 'goals': return <Goals/>;
          case 'reminders': return <Reminders/>;
          case 'chat': return <Chat/>;
          case 'profile': return <Profile/>;
          case 'wellness': return <Wellness/>;
          case 'symptoms': return <Symptoms/>;
          case 'meds': return <Meds/>;
          case 'dialysis': return <Dialysis/>;
          default: return <Home/>;
        }
      };

      React.useEffect(()=>{ // save takenToday daily under date key
        save('rene.meds.taken.'+new Date().toDateString(), takenToday);
      }, [takenToday]);

      return <Page/>;
    };

    ReactDOM.render(React.createElement(App), document.getElementById('root'));
  </script>
</body>
</html>
